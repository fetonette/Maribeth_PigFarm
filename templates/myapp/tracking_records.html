{% extends 'base.html' %}
{% load humanize %}

{% block title %}Tracking Records - Admin{% endblock %}

{% block head %}
    <meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<style>
    .page-header {
        background: #22c55e;
        color: white;
        padding: 40px 0;
        margin: 0 auto 40px auto;
        border-radius: 0 0 25px 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        max-width: 1200px;
        width: 100%;
    }
    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #22c55e;
    }
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #22c55e;
        margin: 0;
    }
    .stat-label {
        color: #6b7280;
        font-size: 0.9rem;
        margin-top: 5px;
    }
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    .chart-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: #1f2937;
    }
    .table-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    .table {
        margin: 0;
    }
    .table th {
        background: #f8f9fa;
        border: none;
        font-weight: 600;
        color: #374151;
        padding: 15px;
    }
    .table td {
        border: none;
        padding: 15px;
        vertical-align: middle;
    }
    .table tbody tr {
        border-bottom: 1px solid #f3f4f6;
    }
    .table tbody tr:hover {
        background: #f9fafb;
    }
    .peak-indicator {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .status-completed {
        background: #dcfce7;
        color: #166534;
    }
    .status-accepted {
        background: #dbeafe;
        color: #1e40af;
    }
    .breed-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .breed-name {
        font-weight: 600;
        color: #374151;
    }
    .breed-stats {
        text-align: right;
    }
    .breed-count {
        font-weight: 700;
        color: #22c55e;
    }
    .breed-revenue {
        font-size: 0.9rem;
        color: #6b7280;
    }
    .payment-checkbox {
        transform: scale(1.5);
        margin: 0;
        cursor: pointer;
    }
    /* Custom dropdown styling */
    #monthFilter {
        width: 250px !important;
        max-width: 250px;
    }
    #monthFilter:focus {
        border-color: #22c55e !important;
        box-shadow: 0 0 0 0.2rem rgba(34, 197, 94, 0.25) !important;
    }
    #monthFilter option:checked {
        background-color: #22c55e !important;
        color: white !important;
    }
</style>

<div class="container-fluid">
    <div class="page-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="page-title">
                        <i class="fas fa-chart-line me-3"></i>Tracking Records
                    </h1>
                    <p class="mb-0 mt-2" style="opacity: 0.9; font-size: 1.1rem;">Monitor completed orders and sales performance</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ total_completed_orders|intcomma }}</div>
            <div class="stat-label">Total Completed Orders</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">₱{{ total_revenue|floatformat:0|intcomma }}</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ recent_orders.count }}</div>
            <div class="stat-label">Orders (Last 30 Days)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ peak_month.month }}</div>
            <div class="stat-label">Peak Sales Month ({{ current_year }})</div>
            {% if peak_month.orders > 0 %}
                <div class="peak-indicator mt-2">{{ peak_month.orders }} orders</div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Monthly Sales Chart -->
        <div class="col-lg-8">
            <div class="chart-container">
                <h3 class="chart-title">Monthly Sales Trend ({{ current_year }})</h3>
                <canvas id="monthlyChart" width="400" height="120"></canvas>
            </div>
        </div>

        <!-- Top Selling Breeds -->
        <div class="col-lg-4">
            <div class="chart-container">
                <h3 class="chart-title">Top Selling Breeds</h3>
                {% for breed in breed_sales %}
                    <div class="breed-item">
                        <div class="breed-name">{{ breed.pig__breed }}</div>
                        <div class="breed-stats">
                            <div class="breed-count">{{ breed.total_sold }} sold</div>
                            <div class="breed-revenue">₱{{ breed.total_revenue|floatformat:0|intcomma }}</div>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">No sales data available</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Completed Orders -->
    <div class="table-container">
        <h3 class="chart-title">
            Recent Completed Orders
            <span class="badge bg-success ms-2">{{ completed_orders.count }} Total</span>
        </h3>
        {% if completed_orders %}
            <div class="mb-3">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                            <select class="form-select" id="monthFilter">
                                <option value="all">All Months</option>
                                <option value="2025-01">January 2025</option>
                                <option value="2025-02">February 2025</option>
                                <option value="2025-03">March 2025</option>
                                <option value="2025-04">April 2025</option>
                                <option value="2025-05">May 2025</option>
                                <option value="2025-06">June 2025</option>
                                <option value="2025-07">July 2025</option>
                                <option value="2025-08">August 2025</option>
                                <option value="2025-09">September 2025</option>
                                <option value="2025-10">October 2025</option>
                                <option value="2025-11">November 2025</option>
                                <option value="2025-12">December 2025</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Order Date</th>
                            <th>Customer</th>
                            <th>Pig Details</th>
                            <th>Price</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Completion Date</th>
                            <th style="text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in completed_orders %}
                        <tr class="log-row" data-month="{{ order.created_at|date:'Y-m' }}">
                            <td>{{ order.created_at|date:"M d, Y" }}</td>
                            <td>
                                <strong>{{ order.fullname }}</strong>
                                <br><small class="text-muted">{{ order.user.email }}</small>
                            </td>
                            <td>
                                <strong>{{ order.pig.breed }}</strong>
                                <br><small class="text-muted">{{ order.pig.get_age_display }}, {{ order.pig.weight_kg }}kg</small>
                            </td>
                            <td>
                                <strong>₱{{ order.pig.price|floatformat:0|intcomma }}</strong>
                            </td>
                            <td class="text-center">
                                {% if user.is_superuser or user.is_staff %}
                                    <input type="checkbox" 
                                           class="payment-checkbox" 
                                           {% if order.is_paid %}checked{% endif %}
                                           data-order-id="{{ order.id }}"
                                           title="{% if order.is_paid %}Paid{% else %}Not paid yet{% endif %}">
                                {% else %}
                                    {% if order.is_paid %}
                                        <i class="fas fa-check-circle text-success" title="Paid"></i>
                                    {% else %}
                                        <i class="fas fa-times-circle text-danger" title="Not paid"></i>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-{{ order.status }}">
                                    {{ order.get_status_display }}
                                </span>
                            </td>
                            <td>{{ order.updated_at|date:"M d, Y" }}</td>
                            <td style="text-align: center; vertical-align: middle; padding: 15px;">
                                {% if order.payment_method == 'gcash' and order.proof_of_payment %}
                                    <a href="{{ order.proof_of_payment.url }}" target="_blank" 
                                       class="btn btn-sm d-inline-flex align-items-center" 
                                       style="background: #f97316; color: white; font-size: 0.8rem; padding: 8px 16px; border-radius: 6px; white-space: nowrap; text-decoration: none; font-weight: 600;"
                                       title="View GCash Payment Proof">
                                        <i class="fas fa-file-image me-2"></i>View Proof
                                    </a>
                                {% else %}
                                    <span class="text-muted" style="font-size: 0.8rem;">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Info -->
            <div class="mt-3 text-center">
                <small class="text-muted">
                    Showing <span id="visibleRows">{{ completed_orders.count }}</span> of {{ completed_orders.count }} completed orders
                </small>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h4>No Completed Orders</h4>
                <p class="text-muted">Completed orders will appear here for tracking and analysis.</p>
            </div>
        {% endif %}
    </div>

    <!-- Yearly Comparison -->
    {% if yearly_sales %}
    <div class="table-container">
        <h3 class="chart-title">Yearly Performance</h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Total Orders</th>
                        <th>Total Revenue</th>
                        <th>Average Order Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for year_data in yearly_sales %}
                    <tr>
                        <td><strong>{{ year_data.year|date:"Y" }}</strong></td>
                        <td>{{ year_data.total_orders|intcomma }}</td>
                        <td>₱{{ year_data.total_revenue|floatformat:0|intcomma }}</td>
                        <td>₱{{ year_data.avg_order_value|floatformat:0|intcomma }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Sales Chart
    const ctx = document.getElementById('monthlyChart');
    if (ctx) {
        try {
            const monthlyData = JSON.parse('{{ monthly_data_json|escapejs }}');
            
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: monthlyData.map(item => item.month),
                    datasets: [{
                        label: 'Orders',
                        data: monthlyData.map(item => item.orders),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating chart:', error);
        }
    }
    
    // Month filter functionality for completed logs
    const monthFilter = document.getElementById('monthFilter');
    if (monthFilter) {
        monthFilter.addEventListener('change', function() {
            filterTable();
        });
    }
    
    // Payment status toggle functionality
    const paymentCheckboxes = document.querySelectorAll('.payment-checkbox');
    paymentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const orderId = this.getAttribute('data-order-id');
            togglePaymentStatus(orderId, this);
        });
    });
});

// Month filter function
function filterTable() {
    const monthFilter = document.getElementById('monthFilter').value;
    const rows = document.querySelectorAll('.log-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const monthData = row.getAttribute('data-month');
        
        // Check month filter match
        const matchesMonth = monthFilter === 'all' || monthData === monthFilter;
        
        // Show/hide row
        if (matchesMonth) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update visible count
    const visibleRowsSpan = document.getElementById('visibleRows');
    if (visibleRowsSpan) {
        visibleRowsSpan.textContent = visibleCount;
    }
}

// Toggle payment status function
function togglePaymentStatus(orderId, checkbox) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value || 
                     document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/api/toggle-payment-status/${orderId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update checkbox tooltip
            checkbox.title = data.is_paid ? 'Paid' : 'Not paid yet';
            
            // Show success message (optional)
            console.log(data.message);
        } else {
            // Revert checkbox if failed
            checkbox.checked = !checkbox.checked;
            alert('Failed to update payment status: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Revert checkbox if failed
        checkbox.checked = !checkbox.checked;
        alert('An error occurred while updating payment status.');
    });
}
</script>
{% endblock %}
